{
  "feature_id": "PD-0001",
  "title": "GitHub Review by sourcery-ai[bot]",
  "summary": "Hey - I've found 3 issues, and left some high level feedback:\n\n- In `Settings.cors_origins_list`, consider filtering out empty strings (e.g. when `CORS_ORIGINS` is unset or has trailing commas) so that `allow_origins` never contains `\"\"`, which can lead to surprising CORS behaviour.\n- As the API surface grows, it may be cleaner to move the `/api/v1` router definition and route registrations into the `app.api` package (e.g. `api/router.py`) and keep `app.main` focused on app construction and middleware wiring.\n\n<details>\n<summary>Prompt for AI Agents</summary>\n\n~~~markdown\nPlease address the comments from this code review:\n\n## Overall Comments\n- In `Settings.cors_origins_list`, consider filtering out empty strings (e.g. when `CORS_ORIGINS` is unset or has trailing commas) so that `allow_origins` never contains `\"\"`, which can lead to surprising CORS behaviour.\n- As the API surface grows, it may be cleaner to move the `/api/v1` router definition and route registrations into the `app.api` package (e.g. `api/router.py`) and keep `app.main` focused on app construction and middleware wiring.\n\n## Individual Comments\n\n### Comment 1\n<location path=\"backend/tests/unit/test_config.py\" line_range=\"7-12\" />\n<code_context>\n+from pydantic import ValidationError\n+\n+\n+def test_settings_loads_with_required_env_vars() -> None:\n+    from app.config import Settings\n+\n+    s = Settings(jwt_secret=\"s3cret\", database_url=\"postgresql+asyncpg://localhost/db\")\n+    assert s.jwt_secret == \"s3cret\"\n+    assert s.database_url == \"postgresql+asyncpg://localhost/db\"\n+\n+\n</code_context>\n<issue_to_address>\n**suggestion (testing):** Add tests that exercise the `database_url` default and env-based override\n\nCurrent tests only cover `database_url` when passed explicitly. To validate the new database layer and CI integration, please also add tests that verify the default `database_url` value and that it can be overridden via the `DATABASE_URL` environment variable (e.g., using `monkeypatch.setenv`).\n\nSuggested implementation:\n\n```python\n\"\"\"Tests for app.config ‚Äî Settings validation and defaults.\"\"\"\n\nimport pytest\nfrom pydantic import ValidationError\n\n\ndef test_settings_loads_with_required_env_vars() -> None:\n    from app.config import Settings\n\n    s = Settings(jwt_secret=\"s3cret\", database_url=\"postgresql+asyncpg://localhost/db\")\n    assert s.jwt_secret == \"s3cret\"\n    assert s.database_url == \"postgresql+asyncpg://localhost/db\"\n\n\ndef test_settings_uses_default_database_url_when_not_provided(monkeypatch: pytest.MonkeyPatch) -> None:\n    from app.config import Settings\n\n    # Ensure DATABASE_URL is not set so the default is used\n    monkeypatch.delenv(\"DATABASE_URL\", raising=False)\n\n    s = Settings(jwt_secret=\"s3cret\")\n    # The exact default value is defined in Settings; update the string below\n    # if the default ever changes.\n    assert s.database_url == \"postgresql+asyncpg://localhost/app\"\n\n\ndef test_settings_uses_database_url_from_env(monkeypatch: pytest.MonkeyPatch) -> None:\n    from app.config import Settings\n\n    env_database_url = \"postgresql+asyncpg://env-host/env-db\"\n    monkeypatch.setenv(\"DATABASE_URL\", env_database_url)\n\n    s = Settings(jwt_secret=\"s3cret\")\n    assert s.database_url == env_database_url\n\n```\n\nThese tests assume that:\n1. `Settings` defines a default `database_url` of `\"postgresql+asyncpg://localhost/app\"`. If the actual default differs, update that string in `test_settings_uses_default_database_url_when_not_provided`.\n2. `Settings` is configured to read `DATABASE_URL` from the environment when `database_url` is not explicitly provided. If the env var name or precedence is different, adjust the `monkeypatch.setenv` key and the construction of `Settings` accordingly.\n</issue_to_address>\n\n### Comment 2\n<location path=\"backend/tests/unit/test_config.py\" line_range=\"47-56\" />\n<code_context>\n+    assert s.log_level == \"DEBUG\"\n+\n+\n+def test_cors_origins_list_splits_comma_separated() -> None:\n+    from app.config import Settings\n+\n+    s = Settings(jwt_secret=\"s3cret\", cors_origins=\"http://a.com, http://b.com , http://c.com\")\n+    assert s.cors_origins_list == [\"http://a.com\", \"http://b.com\", \"http://c.com\"]\n+\n+\n+def test_cors_origins_list_single_origin() -> None:\n+    from app.config import Settings\n+\n+    s = Settings(jwt_secret=\"s3cret\", cors_origins=\"http://localhost:3000\")\n+    assert s.cors_origins_list == [\"http://localhost:3000\"]\n+\n+\n</code_context>\n<issue_to_address>\n**suggestion (testing):** Consider adding an edge-case test for `cors_origins_list` with empty elements/extra commas\n\nCurrent tests cover single and multiple origins, but not malformed input like extra commas/whitespace or an empty string (e.g. `\", http://a.com,, http://b.com ,\"` or `\"\"`). A dedicated test for this case will clarify the expected behavior (whether empty entries are kept or filtered) and guard against regressions if the splitting logic changes.\n</issue_to_address>\n\n### Comment 3\n<location path=\"backend/tests/unit/test_database.py\" line_range=\"28-36\" />\n<code_context>\n+    assert AsyncSessionLocal is not None\n+\n+\n+async def test_get_db_yields_session() -> None:\n+    from app.database import get_db\n+\n+    gen = get_db()\n+    session = await gen.__anext__()\n+    assert isinstance(session, AsyncSession)\n+    # Cleanup\n+    with contextlib.suppress(StopAsyncIteration):\n+        await gen.__anext__()\n</code_context>\n<issue_to_address>\n**suggestion (testing):** Add a test to verify `get_db` rolls back the session when an exception occurs\n\nThe existing test only validates the yielded `AsyncSession` and the happy path. We should also assert the behavior in the `except` block.\n\nFor example, add a test that:\n- Patches `AsyncSessionLocal` to return a session whose `rollback()` we can spy on.\n- Consumes `get_db()` and deliberately raises an exception inside the consumer.\n- Asserts the exception is propagated and that `rollback()` was called.\n\nExact implementation can vary, but we need coverage that `get_db` rolls back the session on error, not just when everything succeeds.\n</issue_to_address>\n~~~\n\n</details>\n\n***\n\n<details>\n<summary>Sourcery is free for open source - if you like our reviews please consider sharing them ‚ú®</summary>\n\n- [X](https://twitter.com/intent/tweet?text=I%20just%20got%20an%20instant%20code%20review%20from%20%40SourceryAI%2C%20and%20it%20was%20brilliant%21%20It%27s%20free%20for%20open%20source%20and%20has%20a%20free%20trial%20for%20private%20code.%20Check%20it%20out%20https%3A//sourcery.ai)\n- [Mastodon](https://mastodon.social/share?text=I%20just%20got%20an%20instant%20code%20review%20from%20%40SourceryAI%2C%20and%20it%20was%20brilliant%21%20It%27s%20free%20for%20open%20source%20and%20has%20a%20free%20trial%20for%20private%20code.%20Check%20it%20out%20https%3A//sourcery.ai)\n- [LinkedIn](https://www.linkedin.com/sharing/share-offsite/?url=https://sourcery.ai)\n- [Facebook](https://www.facebook.com/sharer/sharer.php?u=https://sourcery.ai)\n\n</details>\n\n<sub>\nHelp me be more useful! Please click üëç or üëé on each comment and I'll use the feedback to improve your reviews.\n</sub>",
  "verdict": "ADDRESSED",
  "tests_checklist": [],
  "code_quality_checklist": [],
  "security_checklist": [],
  "architecture_checklist": [],
  "dry_yagni_checklist": [],
  "fail_fast_checklist": [],
  "defensive_checklist": [],
  "security_findings": [],
  "architecture_findings": [],
  "issues_found": [],
  "suggested_improvements": [],
  "next_steps": [],
  "reviewer": "sourcery-ai[bot]",
  "date": "2026-02-28T19:28:22Z",
  "commit_reference": "",
  "review_type": "external",
  "sequence_number": 1,
  "external_feedback": "Hey - I've found 3 issues, and left some high level feedback:\n\n- In `Settings.cors_origins_list`, consider filtering out empty strings (e.g. when `CORS_ORIGINS` is unset or has trailing commas) so that `allow_origins` never contains `\"\"`, which can lead to surprising CORS behaviour.\n- As the API surface grows, it may be cleaner to move the `/api/v1` router definition and route registrations into the `app.api` package (e.g. `api/router.py`) and keep `app.main` focused on app construction and middleware wiring.\n\n<details>\n<summary>Prompt for AI Agents</summary>\n\n~~~markdown\nPlease address the comments from this code review:\n\n## Overall Comments\n- In `Settings.cors_origins_list`, consider filtering out empty strings (e.g. when `CORS_ORIGINS` is unset or has trailing commas) so that `allow_origins` never contains `\"\"`, which can lead to surprising CORS behaviour.\n- As the API surface grows, it may be cleaner to move the `/api/v1` router definition and route registrations into the `app.api` package (e.g. `api/router.py`) and keep `app.main` focused on app construction and middleware wiring.\n\n## Individual Comments\n\n### Comment 1\n<location path=\"backend/tests/unit/test_config.py\" line_range=\"7-12\" />\n<code_context>\n+from pydantic import ValidationError\n+\n+\n+def test_settings_loads_with_required_env_vars() -> None:\n+    from app.config import Settings\n+\n+    s = Settings(jwt_secret=\"s3cret\", database_url=\"postgresql+asyncpg://localhost/db\")\n+    assert s.jwt_secret == \"s3cret\"\n+    assert s.database_url == \"postgresql+asyncpg://localhost/db\"\n+\n+\n</code_context>\n<issue_to_address>\n**suggestion (testing):** Add tests that exercise the `database_url` default and env-based override\n\nCurrent tests only cover `database_url` when passed explicitly. To validate the new database layer and CI integration, please also add tests that verify the default `database_url` value and that it can be overridden via the `DATABASE_URL` environment variable (e.g., using `monkeypatch.setenv`).\n\nSuggested implementation:\n\n```python\n\"\"\"Tests for app.config ‚Äî Settings validation and defaults.\"\"\"\n\nimport pytest\nfrom pydantic import ValidationError\n\n\ndef test_settings_loads_with_required_env_vars() -> None:\n    from app.config import Settings\n\n    s = Settings(jwt_secret=\"s3cret\", database_url=\"postgresql+asyncpg://localhost/db\")\n    assert s.jwt_secret == \"s3cret\"\n    assert s.database_url == \"postgresql+asyncpg://localhost/db\"\n\n\ndef test_settings_uses_default_database_url_when_not_provided(monkeypatch: pytest.MonkeyPatch) -> None:\n    from app.config import Settings\n\n    # Ensure DATABASE_URL is not set so the default is used\n    monkeypatch.delenv(\"DATABASE_URL\", raising=False)\n\n    s = Settings(jwt_secret=\"s3cret\")\n    # The exact default value is defined in Settings; update the string below\n    # if the default ever changes.\n    assert s.database_url == \"postgresql+asyncpg://localhost/app\"\n\n\ndef test_settings_uses_database_url_from_env(monkeypatch: pytest.MonkeyPatch) -> None:\n    from app.config import Settings\n\n    env_database_url = \"postgresql+asyncpg://env-host/env-db\"\n    monkeypatch.setenv(\"DATABASE_URL\", env_database_url)\n\n    s = Settings(jwt_secret=\"s3cret\")\n    assert s.database_url == env_database_url\n\n```\n\nThese tests assume that:\n1. `Settings` defines a default `database_url` of `\"postgresql+asyncpg://localhost/app\"`. If the actual default differs, update that string in `test_settings_uses_default_database_url_when_not_provided`.\n2. `Settings` is configured to read `DATABASE_URL` from the environment when `database_url` is not explicitly provided. If the env var name or precedence is different, adjust the `monkeypatch.setenv` key and the construction of `Settings` accordingly.\n</issue_to_address>\n\n### Comment 2\n<location path=\"backend/tests/unit/test_config.py\" line_range=\"47-56\" />\n<code_context>\n+    assert s.log_level == \"DEBUG\"\n+\n+\n+def test_cors_origins_list_splits_comma_separated() -> None:\n+    from app.config import Settings\n+\n+    s = Settings(jwt_secret=\"s3cret\", cors_origins=\"http://a.com, http://b.com , http://c.com\")\n+    assert s.cors_origins_list == [\"http://a.com\", \"http://b.com\", \"http://c.com\"]\n+\n+\n+def test_cors_origins_list_single_origin() -> None:\n+    from app.config import Settings\n+\n+    s = Settings(jwt_secret=\"s3cret\", cors_origins=\"http://localhost:3000\")\n+    assert s.cors_origins_list == [\"http://localhost:3000\"]\n+\n+\n</code_context>\n<issue_to_address>\n**suggestion (testing):** Consider adding an edge-case test for `cors_origins_list` with empty elements/extra commas\n\nCurrent tests cover single and multiple origins, but not malformed input like extra commas/whitespace or an empty string (e.g. `\", http://a.com,, http://b.com ,\"` or `\"\"`). A dedicated test for this case will clarify the expected behavior (whether empty entries are kept or filtered) and guard against regressions if the splitting logic changes.\n</issue_to_address>\n\n### Comment 3\n<location path=\"backend/tests/unit/test_database.py\" line_range=\"28-36\" />\n<code_context>\n+    assert AsyncSessionLocal is not None\n+\n+\n+async def test_get_db_yields_session() -> None:\n+    from app.database import get_db\n+\n+    gen = get_db()\n+    session = await gen.__anext__()\n+    assert isinstance(session, AsyncSession)\n+    # Cleanup\n+    with contextlib.suppress(StopAsyncIteration):\n+        await gen.__anext__()\n</code_context>\n<issue_to_address>\n**suggestion (testing):** Add a test to verify `get_db` rolls back the session when an exception occurs\n\nThe existing test only validates the yielded `AsyncSession` and the happy path. We should also assert the behavior in the `except` block.\n\nFor example, add a test that:\n- Patches `AsyncSessionLocal` to return a session whose `rollback()` we can spy on.\n- Consumes `get_db()` and deliberately raises an exception inside the consumer.\n- Asserts the exception is propagated and that `rollback()` was called.\n\nExact implementation can vary, but we need coverage that `get_db` rolls back the session on error, not just when everything succeeds.\n</issue_to_address>\n~~~\n\n</details>\n\n***\n\n<details>\n<summary>Sourcery is free for open source - if you like our reviews please consider sharing them ‚ú®</summary>\n\n- [X](https://twitter.com/intent/tweet?text=I%20just%20got%20an%20instant%20code%20review%20from%20%40SourceryAI%2C%20and%20it%20was%20brilliant%21%20It%27s%20free%20for%20open%20source%20and%20has%20a%20free%20trial%20for%20private%20code.%20Check%20it%20out%20https%3A//sourcery.ai)\n- [Mastodon](https://mastodon.social/share?text=I%20just%20got%20an%20instant%20code%20review%20from%20%40SourceryAI%2C%20and%20it%20was%20brilliant%21%20It%27s%20free%20for%20open%20source%20and%20has%20a%20free%20trial%20for%20private%20code.%20Check%20it%20out%20https%3A//sourcery.ai)\n- [LinkedIn](https://www.linkedin.com/sharing/share-offsite/?url=https://sourcery.ai)\n- [Facebook](https://www.facebook.com/sharer/sharer.php?u=https://sourcery.ai)\n\n</details>\n\n<sub>\nHelp me be more useful! Please click üëç or üëé on each comment and I'll use the feedback to improve your reviews.\n</sub>",
  "code_comments": [
    {
      "body": "**suggestion (testing):** Add tests that exercise the `database_url` default and env-based override\n\nCurrent tests only cover `database_url` when passed explicitly. To validate the new database layer and CI integration, please also add tests that verify the default `database_url` value and that it can be overridden via the `DATABASE_URL` environment variable (e.g., using `monkeypatch.setenv`).\n\nSuggested implementation:\n\n```python\n\"\"\"Tests for app.config ‚Äî Settings validation and defaults.\"\"\"\n\nimport pytest\nfrom pydantic import ValidationError\n\n\ndef test_settings_loads_with_required_env_vars() -> None:\n    from app.config import Settings\n\n    s = Settings(jwt_secret=\"s3cret\", database_url=\"postgresql+asyncpg://localhost/db\")\n    assert s.jwt_secret == \"s3cret\"\n    assert s.database_url == \"postgresql+asyncpg://localhost/db\"\n\n\ndef test_settings_uses_default_database_url_when_not_provided(monkeypatch: pytest.MonkeyPatch) -> None:\n    from app.config import Settings\n\n    # Ensure DATABASE_URL is not set so the default is used\n    monkeypatch.delenv(\"DATABASE_URL\", raising=False)\n\n    s = Settings(jwt_secret=\"s3cret\")\n    # The exact default value is defined in Settings; update the string below\n    # if the default ever changes.\n    assert s.database_url == \"postgresql+asyncpg://localhost/app\"\n\n\ndef test_settings_uses_database_url_from_env(monkeypatch: pytest.MonkeyPatch) -> None:\n    from app.config import Settings\n\n    env_database_url = \"postgresql+asyncpg://env-host/env-db\"\n    monkeypatch.setenv(\"DATABASE_URL\", env_database_url)\n\n    s = Settings(jwt_secret=\"s3cret\")\n    assert s.database_url == env_database_url\n\n```\n\nThese tests assume that:\n1. `Settings` defines a default `database_url` of `\"postgresql+asyncpg://localhost/app\"`. If the actual default differs, update that string in `test_settings_uses_default_database_url_when_not_provided`.\n2. `Settings` is configured to read `DATABASE_URL` from the environment when `database_url` is not explicitly provided. If the env var name or precedence is different, adjust the `monkeypatch.setenv` key and the construction of `Settings` accordingly.",
      "path": "backend/tests/unit/test_config.py",
      "line": 12,
      "author": "sourcery-ai[bot]",
      "created_at": "2026-02-28T19:28:22Z",
      "id": null
    },
    {
      "body": "**suggestion (testing):** Consider adding an edge-case test for `cors_origins_list` with empty elements/extra commas\n\nCurrent tests cover single and multiple origins, but not malformed input like extra commas/whitespace or an empty string (e.g. `\", http://a.com,, http://b.com ,\"` or `\"\"`). A dedicated test for this case will clarify the expected behavior (whether empty entries are kept or filtered) and guard against regressions if the splitting logic changes.",
      "path": "backend/tests/unit/test_config.py",
      "line": 56,
      "author": "sourcery-ai[bot]",
      "created_at": "2026-02-28T19:28:22Z",
      "id": null
    },
    {
      "body": "**suggestion (testing):** Add a test to verify `get_db` rolls back the session when an exception occurs\n\nThe existing test only validates the yielded `AsyncSession` and the happy path. We should also assert the behavior in the `except` block.\n\nFor example, add a test that:\n- Patches `AsyncSessionLocal` to return a session whose `rollback()` we can spy on.\n- Consumes `get_db()` and deliberately raises an exception inside the consumer.\n- Asserts the exception is propagated and that `rollback()` was called.\n\nExact implementation can vary, but we need coverage that `get_db` rolls back the session on error, not just when everything succeeds.",
      "path": "backend/tests/unit/test_database.py",
      "line": 36,
      "author": "sourcery-ai[bot]",
      "created_at": "2026-02-28T19:28:22Z",
      "id": null
    }
  ]
}